Overview
********

This documents tools and processes used to obtain register configuration
sets for the RF1A module in the CC430 SOC.

Presence of a configuration in this directory should not be taken as
evidence that the configuration is suitable for use in any system.  Some
exist simply to analyze the behavior of the supporting tools.  Understand
the provenance of and differences between configurations, and evaluate them
in actual use, prior to selecting one for an application.

If you're going to ignore that sage advice, though, prefer the
configurations beginning with SRFS_.

Radio Configurations
====================

Radio configurations are best generated using TI's SmartRF Studio tool.  The
data sheet for the RF1A module frequently suggests that preferred settings
for specific registers are the ones suggested by SmartRF Studio.

The tool provides initial configurations for different data rates and
frequencies.  Many of the register settings in these configurations are
unjustified by the chip documentation; e.g. why the ADC_RETENTION bit should
be set for 1.2 kbaud but not 250 kbaud in 902MHz modes.

The SmartRF Studio tool is designed for use with directly-connected
experimenter boards.  Other register settings are relevant only to use in
that form: for example, whether CRC is enabled, packet length, sync word
qualifiers, etc.

Exporting Registers
-------------------

SRFS provides the ability to export register configurations in a variety of
formats.  All versions of SRFS come with a format to export for SimpliciTI.
While the TinyOS source code is prepared to read configurations from these
files, the files do not include PATABLE and other useful information such as
the actual description of the configuration in comments as generated by
@PARAM@.

Copy the configs/rf1a_regs.sfrsexpCC430 file to the config/codexport
subdirectory of your SmartRF Studio 7 installation and use that to export
something more useful.  This format has been used to export all header files
provided in this directory, from configurations stored int he configs
subdirectory.

Vendor-Provided Configurations
------------------------------

SmartRF Studio 6
^^^^^^^^^^^^^^^^

The following configurations have been generated from SmartRF Studio 6,
version 6.13.1 (Rev. S), released 28 January 2010, using the CC430 device
control panel.

SRFS6_RESET -- What you get with "Reset Configuration" from the File menu.

SRFS6_868_GFSK_1p2K_SENS -- 1.2 kBaud, 5.2 kHz deviation, GFSK modulation,
58 kHz RX BW, optimized for sensitivity.

SRFS6_868_GFSK_1p2K_CUR -- 1.2 kBaud, 5.2 kHz deviation, GFSK modulation, 58
kHz RX BW, optimized for current.

SRFS6_868_2FSK_1p2K_SENS -- 1.2 kBaud, 5.2 kHz deviation, 2-FSK modulation,
58 kHz RX BW, optimized for sensitivity.

SRFS6_868_GFSK_2p4K_SENS -- 2.4 kBaud, 5.2 kHz deviation, GFSK modulation,
58 kHz RX BW, optimized for sensitivity.

SRFS6_868_GFSK_2p4K_CUR -- 2.4 kBaud, 5.2 kHz deviation, GFSK modulation,
58 kHz RX BW, optimized for current.

SRFS6_868_GFSK_4p8K_SENS -- 4.8 kBaud, 25.4 kHz deviation, GFSK modulation,
100 kHz RX BW, optimized for sensitivity.

SRFS6_868_GFSK_4p8K_CUR -- 4.8 kBaud, 25.4 kHz deviation, GFSK modulation,
100 kHz RX BW, optimized for current.

SRFS6_868_GFSK_10K_SENS -- 10 kBaud, 19 kHz deviation, GFSK modulation, 100
kHz RX BW, optimized for sensitivity.

SRFS6_868_GFSK_10K_CUR -- 10 kBaud, 19 kHz deviation, GFSK modulation, 100
kHz RX BW, optimized for current.

SRFS6_868_GFSK_38p4K_SENS -- 38.4 kBaud, 20 kHz deviation, GFSK modulation,
100 kHz RX BW, optimized for sensitivity.

SRFS6_868_GFSK_38p4K_CUR -- 38.4 kBaud, 20 kHz deviation, GFSK modulation,
100 kHz RX BW, optimized for current.

SRFS6_868_GFSK_76p8K_SENS -- 76.8 kBaud, 32 kHz deviation, GFSK modulation,
232 kHz RX BW, optimized for sensitivity.

SRFS6_868_GFSK_76p8K_CUR -- 76.8 kBaud, 32 kHz deviation, GFSK modulation,
232 kHz RX BW, optimized for current.

SRFS6_868_GFSK_100K_SENS -- 100 kBaud, 47 kHz deviation, GFSK modulation,
325 kHz RX BW, optimized for sensitivity.

SRFS6_868_GFSK_100K_CUR -- 100 kBaud, 47 kHz deviation, GFSK modulation,
325 kHz RX BW, optimized for current.

SRFS6_868_GFSK_175K_SENS -- 175 kBaud, 95 kHz deviation, GFSK modulation,
464 kHz RX BW, optimized for sensitivity.

SRFS6_868_GFSK_175K_CUR -- 175 kBaud, 95 kHz deviation, GFSK modulation,
464 kHz RX BW, optimized for current.

SRFS6_868_GFSK_250K_SENS -- 250 kBaud, 127 kHz deviation, GFSK modulation,
540 kHz RX BW, optimized for sensitivity.

SRFS6_868_GFSK_250K_CUR -- 250 kBaud, 127 kHz deviation, GFSK modulation,
540 kHz RX BW, optimized for current.

SRFS6_868_MSK_500K -- 500 kBaud, 0 devation, MSK modulation, 812 kHz RX BW.

SmartRF Studio 7
^^^^^^^^^^^^^^^^

The following configurations have been generated from SmartRF Studio 7,
version 1.2.3 (Rev. E), released 17 August 2010, using the CC430 device control
panel.  Note that "Easy Mode" and "Expert Mode" have completely independent
configurations.

**WARNING** SRFS7 changes register configurations when you move between
  Continuous TX and Packet RX windows in Expert mode.  You want to be in
  Packet RX.

RESET -- The power-on reset values of the RF1A module in the CC430.  Obtain
these by opening the Register View, then clicking "Register Reset" multiple
times until all register names are in non-bold black font.  (My experience
with SRFS leaves me concerned that loading a configuration file does not
always reset all the register settings.  The recorded values for the
subsequent configurations were obtained after first resetting all registers
to their power-on values in this manner.)

SRFS7_RESET -- What you get with "Reset Configuration" from Smart RF Studio 7
with the CC430 device panel.  

SRFS7_STI_902_GFSK_250K -- The "Easy Mode" SimpliciTI Ping packet, High data
rate (250 kbaud), Base frequency 902 MHz configuration.

SRFS7_STI_902_GFSK_1p2K -- The "Easy Mode" SimpliciTI Ping packet, Low data
rate (1.2 kbaud), Base frequency 902 MHz configuration.

SRFS7_868_GFSK_1p2K_SENS -- The "Expert Mode" Data rate: 1.2 kBaud, Dev.:
5.2 kHz, Mod.: GFSK, RX BW: 58 kHz, Optimized for Sensitivity configuration.

SRFS7_868_GFSK_1p2K_CUR -- The "Expert Mode" Data rate: 1.2 kBaud, Dev.: 5.2
kHz, Mod.: GFSK, RX BW: 58 kHz, Optimized for current consumption
configuration. (NOTE: In fact, this has a 2-FSK rather than 2-GFSK
modulation.)

SRFS7_868_2FSK_1p2K_SENS -- The "Expert Mode" Data rate: 1.2 kBaud, Dev.:
5.2 kHz, Mod.: 2-FSK, RX BW: 58 kHz, Optimized for Sensitivity
configuration.

SRFS7_868_GFSK_38p4K_SENS -- The "Expert Mode" Data rate: 38.4 kBaud, Dev.:
20 kHz, Mod.: GFSK, RX BW: 100 kHz, Optimized for Sensitivity configuration.

SRFS7_868_GFSK_38p4K_CUR -- The "Expert Mode" Data rate: 38.4 kBaud, Dev.:
20 kHz, Mod.: GFSK, RX BW: 100 kHz, Optimized for current consumption
configuration. (NOTE: In fact, this has a 2-FSK rather than 2-GFSK
modulation.)

SRFS7_868_GFSK_175K_SENS -- The "Expert Mode" Data rate: 175 kBaud, Dev.: 95
kHz, Mod.: GFSK, RX BW: 464 kHz, Optimized for Sensitivity configuration.

SRFS7_868_GFSK_175K_CUR -- The "Expert Mode" Data rate: 175 kBaud, Dev.: 95
kHz, Mod.: GFSK, RX BW: 464 kHz, Optimized for current consumption
configuration.

SRFS7_868_GFSK_250K_SENS -- The "Expert Mode" Data rate: 250 kBaud, Dev.: 95
kHz, Mod.: GFSK, RX BW: 464 kHz, Optimized for Sensitivity configuration.

SRFS7_868_GFSK_250K_CUR -- The "Expert Mode" Data rate: 250 kBaud, Dev.: 95
kHz, Mod.: GFSK, RX BW: 464 kHz, Optimized for current consumption
configuration.

TINYOSRF1A -- RESET + the register settings in the original
physical/smartrf_RF1A.h file.  Effectively, what's been used as long as the
RF1A module has been around. *NOTE* The FSCAL* values from
physical/smartrf_RF1A.h are rejected by SRFS; any attempt to set them to the
legacy values is ignored.  However, once the resulting configuration is
programmed, the values read back from those registers have changed and match
the ones recorded in physical/smartrf_RF1A.h  So don't worry about it.

CC430_50kbps_135kHzBW -- SRFS7 config only.  Provided by TI as one
approach for 802.15.4G radio configuration.  Note that this has a base
frequency of 915MHz at channel 0, so is not suitable as-is.

SRFS7_902p2_GFSK_50K_135B -- Same as CC430_50kbps_135kHzBW, but with base
frequency set to 902.2 MHz per 802.15.4G specification.

CC430_50kbps_162kHzBW -- SRFS7 config only.  Provided by TI as one
approach for 802.15.4G radio configuration.  Note that this has a base
frequency of 915MHz at channel 0, so is not suitable as-is.

SRFS7_902p2_GFSK_50K_163B -- Same as CC430_50kbps_162kHzBW, but with base
frequency set to 902.2 MHz per 802.15.4G specification.

SRFS7_779_MSK_250K -- China's ISM band is 779-787 MHz.  The current version of
SmartRF Studio 7 does not actually go below 800 MHz, but the CC430 does 
support it and those frequency registers can be manually calculated, as was 
done for the SRFS7_770_MSK_250K.h file. China's 802.15.4c defines 250kbps 
O-QPSK modulation, which is very similar to MSK with the exception that MSK uses
half-sinusoids instead of O-QPSK's square waves.  What is not implemented from 
the 802.15.4c PHY is the channel bandwidth and any phase transition time 
differences between the standard MSK implementation and the 802.15.4c's O-QPSK 
definition.  Channel 0 in the SRFS7_770_MSK_250K.h is at 779.0 MHz, with
200 kHz channel bandwidth which was only selected because it is the
default given in SmartRF studio.


Review of Vendor-Provided Configurations
----------------------------------------

Consistent differences between SRFS6 and SRFS7:

                     SRFS6   SRFS7
IOCFG2                 29      0b
IOCFG0                 06      2d
PKTCTRL0.PKT_FORMAT     0       1
PKTCTRL0.CRC_EN         1       0
PKTCTRL0.LENGTH_CONFIG  1       2
FREQ1                  65      62
FREQ0                  6a      76
MDMCFG2.SYNC_MODE       3       0
MCSM0.Reserved[3:2]     2       0

SmartRF Studio 6
^^^^^^^^^^^^^^^^

In SRFS6, the configurations for 4.8, 10, 38.4, 76.8, and 100 kBaud all
change FSCTRL1.FREQ_IF when MDMCFG2.DEM_DCFILT_OFF changes; the 1.2, 2.4,
175, and 250 kBaud configurations do not.

SmartRF Studio 7
^^^^^^^^^^^^^^^^

In the Expert Mode configurations, the second configuration, 1.2kBaud 5.2kHz
optimized for current consumption, is mis-labeled as being a GFSK
modulation.  The settings have it as a 2-FSK modulation: both
MDMCFG2.DEM_DCFILT_OFF and MDMCFG2.MOD_FORMAT are changed.

The same mis-labelling holds with the 38.4kB configuration.

The 175 and 250 kBaud configurations are correctly labelled, but unlike the
38.4kB one do not change FSCTRL1.FREQ_IF when MDMCFG2.DEM_DCFILT_OFF
changes.  The documentation implies that SmartRF Studio should be
calculating a different FREQ_IF in this situation, but it doesn't seem to do
so.

Custom 802.15.4G Configurations
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

The two provided configurations differ only in the RX filter bandwidth.  The
AGCCTRL and FREND1 register settings match the SRFS6 38p4K configuration,
while the FOCCFG and BSCFG settings match the 76p8K configuration.  The new
configuration disables ADC_RETENTION, with both the 38p4 and 76p8
configurations had enabled.

General Conclusions
^^^^^^^^^^^^^^^^^^^

The SimpliciTI configurations, which nominally differ only in data rate,
also have many significant changes in registers that affect frequency
synthesis, frequency offset compensation, bit synchronization, automated
gain control, and the front-end configuration.  The analysis of derived
configurations described below shows that these differences were not
automatically provided by SRFS when the data rate was changed.  A reasonable
assumption is that the tuning was performed by an RF specialized at TI who
knows the internals of the RF1A module and tuned it using SRFS with
experimental boards.  The STI_902 configuration is consistent with the 868
configuration for the same data rate.

TI's RF support team has stated that users wishing to change radio
parameters should select the closes example configuration, and modify only
those parameters that must be changed.  It was suggested that "closest"
should be based on the RX filter bandwidth configuration, selecting an
example with a higher rather than lower bandwidth if an exact match cannot
be found.

All in all, the user who simply wishes to derive a new configuration with a
different data rate is left with little choice but to hire a highly-paid
RF engineer as a consultant.

Amateur Theory
^^^^^^^^^^^^^^

"RX filter BW" in SRFS is CHANNBW in the RF1A registers, and "channel filter
bandwidth" in section 19.3.4 of the data sheet.  The data sheet specifies
that the signal bandwidth should occupy at most 80% of this width.

Carson's Rule specifies that the bandwidth required is 2(dF+f_m) where dF is
the peak frequency deviation and f_m is the highest frequency of the
modulating signal (apparently, the data rate).

Assume f_XOSC is 26*10^6, the suggested default.  Section 19.3.4 suggests
frequency uncertainty of +/- 20ppm for sender and receiver.  Total frequency
uncertainty is then +/- 40ppm of f_carrier.  Assuming f_carrier is 915 MHz,
the center of the ITU region 2 ISM band, the frequncy uncertainty is 37kHz.

I have no idea how deviation is determined.  Below are the representable
deviation values:

Representable DEVIATN values (kHz):
DV_E     DV_M=0     DV_M=1     DV_M=2     DV_M=3     DV_M=4     DV_M=5     DV_M=6     DV_M=7 
00:        1.59       1.79       1.98       2.18       2.38       2.58       2.78       2.98 
01:        3.17       3.57       3.97       4.36       4.76       5.16       5.55       5.95 
02:        6.35       7.14       7.93       8.73       9.52      10.31      11.11      11.90 
03:       12.70      14.28      15.87      17.46      19.04      20.63      22.22      23.80 
04:       25.39      28.56      31.74      34.91      38.09      41.26      44.43      47.61 
05:       50.78      57.13      63.48      69.82      76.17      82.52      88.87      95.21 
06:      101.56     114.26     126.95     139.65     152.34     165.04     177.73     190.43 
07:      203.12     228.52     253.91     279.30     304.69     330.08     355.47     380.86 

Representable RX Filter BW values (kHz):
BW_E     BW_M=0     BW_M=1     BW_M=2     BW_M=3 
00:      812.50     650.00     541.67     464.29 
01:      406.25     325.00     270.83     232.14 
02:      203.12     162.50     135.42     116.07 
03:      101.56      81.25      67.71      58.04 

Note that the available filter bandwidth must be selected from these sixteen
supported values.  SRFS selects the smallest value at least as large as the
entered one; e.g. if you enter 542 you'll get 650 instead of 541.67.

Amateur calculation says that, given a data rate f_m, a deviation dF, and a
frequency uncertainty of f_unc (~ 37 kHz) the suggested channel bandwidth
should be:

   BW = 2(f_m + dF + f_unc) / 0.8

As noted in
http://e2e.ti.com/support/low_power_rf/f/155/p/15810/60855.aspx#60855, the
actual settings in the provided TI example files have very little in common
with what this calculation suggests.  Hence my distrust of both these
configurations and anything that is not based on actual experimentation with
actual radios with their real antennas.

Derived Configurations
----------------------

General Principles
^^^^^^^^^^^^^^^^^^

FM-band (generally 87.5MHz to 108MHz) channel spacing is 200KHz, which is
presumably why it is used in all Smart RF Studio example configurations.  Be
aware that this is a poor choice in many cases, since the deviation and RX
filter bandwidths for higher data rates cause the signal to overlay multiple
200KHz channels.  The standard for frequency deviation with this spacing is
75kHz.

ISM band in region 2 is 902-928MHz.  To avoid bleeding outside that band, it
might seem to make sense to set the base frequency to:

   f_base = 902MHz + max(df_channel / 2, deviatn)

TI's example files instead just leave f_base at 902MHz.  They then set
channr to 20, to ensure that RF legality is retained.

802.15.4G Desired Characteristics
---------------------------------

Values from P802.15.4g/d1, March 2010.  Selected base configuration is the
915 MHz PHY, frequencies ranging from 902 to 928 MHz, FSK/GFSK modulation
and the mandatory 50 kBaud data rate.

Data Rate: 50 kBaud.  (Mandatory mode for MR-FSK PHY.)

Deviation: 25 kHz.  (Derived from data rate per 6.12a.1 and modulation index
1 specified for this mode in table 1a.)

Channel Width: 200 kHz.  (Defined by table 1a for this mode.)

RF Frequency: 902.2 MHz.  (Derived from 6.1.2.5a.3 which specifies center
frequency for channel zero.)

RF Filter Bandwidth: No clear direction.  Per TI support, select example
configuration closest to but above desired data rate.  This would be the
76.8 kBaud one.

Channel Number: 0 (default, not relevant)

It is unclear whether FSK and GFSK are actually equally valid.  Table 1a has
a footnote implying they are; figure 22d suggests the selection depends on
the data rate.

6.12a.2 Data Whitening: optional, unclear whether RF1A follows rules.

SRFS6_PRE802154G comprises SRFS6_868_GFSK_76p8K_SENS with these changes:
base frequency 902.2, data rate 50 kBaud, deviation 25 kHz.

*NOTE*: Vendor configurations SRFS7_902p2_GFSK_50K_135B and
SRFS7_902p2_GFSK_50K_163B should be used in preference to the derived
SRFS6_PRE802154G.  The former have front-end and AGC settings that should
provide better reception performance.

Configurations
^^^^^^^^^^^^^^
BASE -- RESET + base frequency 902, channel 20, channel spacing 200 kHz,
modulation 2-GFSK

902_2GFSK_250K -- BASE + data rate 250, RX filter BW 540, deviation 125

902_2GFSK_1p2K -- BASE + data rate 1.2, RX filter BW 50, deviation 5.25

PRE802154G -- BASE + base frequency 902.2, channel 0, data rate 50 kbaud, RX
filter bandwidth 150 kHz, deviation 25 kHz

SRFSBASE -- SRFSRESET; MDMCFG2.SYNC_MODE to 30/32+carrier_sense
(MDMCFG2=0x17); PKTCTRL0.WHITE_DATA to on, PKTCTRL0.PKT_FORMAT to normal
(PKTCTRL0=0x45).

SRFS_902_2GFSK_250K -- SRFSBASE + data rate 250, RX filter BW 540, deviation
125

SRFS_902_2GFSK_1p2K -- SRFSBASE + data rate 1.2, RX filter BW 50, deviation
5.25

SRFS_TINYOSRF1A -- SRFSBASE + channel 10, data rate 10, RX filter BW 100,
deviation 20.  The resulting differences from TINYOSRF1A are:
FIFOTHR.ADC_RETENTION is set, FSCTRL1.FREQ_IF changes to 304.7 kHz (from
152.3 kHz); MDMCFG2.SYNC_MODE changes to 30/32+carrier (from 30/32); FOCCFG,
BSCFG, AGCCTL* all change; FREND1.LNA_CURRENT and FREND1.LNA2MIX_CURRENT
change.

SRFS_PRE802154G -- SRFSBASE + base frequency 902.2, channel 0, data rate 50
kbaud, RX filter bandwidth 150 kHz, deviation 25 kHz

Review of Derived Configurations
--------------------------------

Comparing 902_2GFSK_1p2K with 902_2GFSK_250K shows that SRFS does not
automatically provide the FOCFG, BSCFG, AGCCTL*, and other changes that are
present in the SimpliciTI recommended configurations.

The further you get from SRFS_902_2GFSK_250K, the less likely it is that you
have a configuration that is optimal.

However, the SRFS_TINYOSRF1A configuration does provide a detectable
improvement in RSSI in at least some cases.

